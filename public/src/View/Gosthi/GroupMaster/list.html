<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Master</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        .btn {
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }

        .btn-add {
            background-color: #2196F3;
            color: white;
        }

        .btn-update {
            background-color: #4CAF50;
            color: white;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            width: 400px;
            border-radius: 8px;
        }
    </style>
</head>

<body>

    <h1>Gosthi Type List</h1>
    <button class="btn btn-add" onclick="openAddModal()">+ Add Gosthi Type</button>

    <table>
        <thead>
            <tr>
                <th>S.No.</th>
                <th>Region</th>
                <th>Mandir</th>
                <th>Kshetra</th>
                <th>Group Code</th>
                <th>Group Name</th>
                <th>Gosthi</th>
                <th>Created by</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="GosthiType-table-body"></tbody>
    </table>

    <!-- Add Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3>Add New GosthiType</h3>
            <form id="addForm">
                <label>Zone:</label>
                <select id="addZone" required onchange="fetchZoneCode(this.value)"></select><br><br>

                <label>Mandir:</label>
                <select id="addMandir"></select><br><br>

                <label>Kshetra:</label>
                <select id="addkshetra"></select><br><br>

                <label>Zone Code:</label>
                <input type="text" id="zone_code" readonly><br><br>

                <label>Zone No:</label>
                <input type="text" id="zone_no" readonly><br><br>

                <button type="submit" class="btn btn-add">Add</button>
                <button type="button" onclick="closeAddModal()" class="btn">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Update Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <h3>Update GosthiType</h3>
            <form id="updateForm">
                <input type="hidden" id="updateGosthiTypeId">
                <label for="updateGosthiTypeName">Gosthi Type Name:</label>
                <input type="text" id="updateGosthiTypeName" required>
                <br><br>
                <button type="submit" class="btn btn-update">Save</button>
                <button type="button" onclick="closeUpdateModal()" class="btn">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Fetch GosthiType list
        function LoadGosthiGroup() {
            fetch('/GosthiGroup/list')
                .then(res => res.json())
                .then(data => {
                    const tableBody = document.getElementById('GosthiType-table-body');
                    tableBody.innerHTML = '';
                    data.forEach((GosthiType, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
              <td>${index + 1}</td>
              <td>${GosthiType.zone_name}</td>
              <td>${GosthiType.mandir_name}</td>
              <td>${GosthiType.kshetra_name}</td>
              <td>${GosthiType.group_code}</td>
             <td>${GosthiType.group_name}</td> 
             <td></td>            
              <td>${GosthiType.full_name}</td>
              <td>
                <button class="btn btn-update" onclick="openUpdateModal(${GosthiType.group_id}, '${GosthiType.zone_name},${GosthiType.mandir_name},${GosthiType.kshetra_name},${GosthiType.group_code},${GosthiType.group_name},
                ')">Update</button>
                <button class="btn btn-delete" onclick="deleteGosthiType(${GosthiType.group_id})">Delete</button>
              </td>
            `;
                        tableBody.appendChild(row);
                    });
                });
        }

        function LoadZones(selectId, selectedValue = null) {
            fetch('/zone/list')
                .then(res => res.json())
                .then(zones => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">-- Select Zone --</option>';
                    zones.forEach(z => {
                        const opt = document.createElement('option');
                        opt.value = z.zone_id;
                        opt.textContent = z.zone_name;
                        if (selectedValue && selectedValue == z.zone_id) opt.selected = true;
                        select.appendChild(opt);
                    });
                });
        }

        function loadMandir(zone_id, selectId, selectedValue = null) {
            fetch(`/common/getmandirbyzone?zone_id=${zone_id}`)
                .then(res => res.json())
                .then(mandirs => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">-- Select Mandir --</option>';
                    mandirs.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.mandir_id;
                        opt.textContent = m.mandir_name;
                        if (selectedValue && selectedValue == m.mandir_id) opt.selected = true;
                        select.appendChild(opt);
                    });
                });
        }

        function loadKshetra(zone_id, selectId, selectedValue = null) {
            fetch(`/common/getkshetraforgroupmaster?zone_id=${zone_id}`)
                .then(res => res.json())
                .then(kshetras => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">-- Select Mandir --</option>';
                    kshetras.forEach(k => {
                        const opt = document.createElement('option');
                        opt.value = k.kshetra_id;
                        opt.textContent = k.kshetra_name;
                        if (selectedValue && selectedValue == k.kshetra_id) opt.selected = true;
                        select.appendChild(opt);
                    });
                });
        }

        function fetchZoneCode(zone_id) {
            fetch(`/common/getZoneCodes?zone_id=${zone_id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('zone_code').value = data.zone_code || '';
                    document.getElementById('zone_no').value = data.zone_no || '';
                })
                .catch(err => console.error('Error fetching zone code:', err));
        }







        // --- Add Modal ---
        function openAddModal() {
            LoadZones('addZone');
            document.getElementById('addMandir').innerHTML = '<option value="">-- Select Mandir --</option>';
            document.getElementById('addkshetra').innerHTML = '<option value="">-- Select Kshetra --</option>';

            document.getElementById('addModal').style.display = 'block';
        }

        document.getElementById('addZone').addEventListener('change', function() {
            if (this.value) loadKshetra(this.value, 'addkshetra');
        });

        document.getElementById('addZone').addEventListener('change', function() {
            if (this.value) loadMandir(this.value, 'addMandir');
        });

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const gosthi_topic_type = document.getElementById('addGosthiTypeName').value;

            fetch('/GosthiGroup/addGosthiType', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gosthi_topic_type
                    })
                })
                .then(res => res.json())
                .then(result => {
                    closeAddModal();
                    LoadGosthiGroup();
                    window.location.reload(); // ðŸ”„ refresh whole page

                });
        });

        // --- Update Modal ---
        function openUpdateModal(id, name) {
            document.getElementById('updateGosthiTypeId').value = id;
            document.getElementById('updateGosthiTypeName').value = name;
            document.getElementById('updateModal').style.display = 'block';
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }
        document.getElementById('updateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('updateGosthiTypeId').value;
            const gosthi_topic_type = document.getElementById('updateGosthiTypeName').value;

            fetch(`/GosthiGroup/update/${id}`, {
                    method: 'POST', // keep POST if your backend expects it
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gosthi_topic_type
                    })
                })
                .then(res => res.json())
                .then(result => {
                    closeUpdateModal();
                    LoadGosthiGroup();
                    window.location.reload(); // ðŸ”„ refresh whole page

                });
        });

        // --- Delete ---
        function deleteGosthiType(id) {
            if (confirm("Are you sure you want to delete this Gosthi Type?")) {
                fetch(`/GosthiGroup/delete/${id}`, {
                        method: 'DELETE'
                    }) // keep POST if backend expects it
                    .then(res => res.json())
                    .then(result => {
                        alert(result.message);
                        LoadGosthiGroup();
                        window.location.reload(); // ðŸ”„ refresh whole page

                    });
            }
        }

        // Initial load
        LoadGosthiGroup();
    </script>

</body>

</html>